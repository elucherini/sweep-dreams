name: Release iOS

on:
  push:
    branches: [main]
    paths:
      - "flutter_app/**"

permissions:
  contents: write

jobs:
  release:
    runs-on: macos-latest
    defaults:
      run:
        working-directory: flutter_app

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine version bump from commits
        id: version
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            echo "No previous tags found, starting from v0.1.0"
            echo "version=0.1.0" >> $GITHUB_OUTPUT
            echo "build_number=1" >> $GITHUB_OUTPUT
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "last_tag=" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Last tag: $LAST_TAG"
          COMMITS=$(git log ${LAST_TAG}..HEAD --oneline -- flutter_app)

          if [ -z "$COMMITS" ]; then
            echo "No flutter_app changes since last tag"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Commits since last tag:"
          echo "$COMMITS"

          # Parse current version
          CURRENT_VERSION=${LAST_TAG#v}
          MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
          MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
          PATCH=$(echo $CURRENT_VERSION | cut -d. -f3 | cut -d+ -f1)
          BUILD_NUMBER=$(echo $CURRENT_VERSION | grep -oE '\+[0-9]+' | tr -d '+' || echo "0")
          BUILD_NUMBER=$((BUILD_NUMBER + 1))

          # Determine bump type from conventional commits
          if echo "$COMMITS" | grep -qiE '^[a-f0-9]+ [^:]*!:|BREAKING CHANGE'; then
            MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0
            echo "Breaking change detected - major bump"
          elif echo "$COMMITS" | grep -qiE '^[a-f0-9]+ feat'; then
            MINOR=$((MINOR + 1)); PATCH=0
            echo "Feature detected - minor bump"
          elif echo "$COMMITS" | grep -qiE '^[a-f0-9]+ fix'; then
            PATCH=$((PATCH + 1))
            echo "Fix detected - patch bump"
          else
            echo "No conventional commits (feat/fix/breaking) found, skipping release"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "version=${MAJOR}.${MINOR}.${PATCH}" >> $GITHUB_OUTPUT
          echo "build_number=${BUILD_NUMBER}" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "last_tag=${LAST_TAG}" >> $GITHUB_OUTPUT

      - name: Skip if no release needed
        if: steps.version.outputs.skip == 'true'
        run: echo "No version bump needed based on commits"

      - name: Set up Flutter
        if: steps.version.outputs.skip != 'true'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.3"
          channel: stable
          cache: true

      - name: Set up Ruby
        if: steps.version.outputs.skip != 'true'
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: true
          working-directory: flutter_app/ios

      - name: Install Flutter dependencies
        if: steps.version.outputs.skip != 'true'
        run: flutter pub get

      - name: Build and upload to App Store Connect
        if: steps.version.outputs.skip != 'true'
        working-directory: flutter_app/ios
        env:
          # App Store Connect API
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.ASC_KEY_CONTENT }}
          # Match (code signing)
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          # App build config
          API_URL_PROD: ${{ secrets.API_URL_PROD }}
          WEB_PUSH_CERTIFICATE_PAIR: ${{ secrets.WEB_PUSH_CERTIFICATE_PAIR }}
        run: |
          bundle exec fastlane release \
            version:${{ steps.version.outputs.version }} \
            build_number:${{ steps.version.outputs.build_number }}

      - name: Create and push tag
        if: steps.version.outputs.skip != 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}+${{ steps.version.outputs.build_number }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Tag the current commit (no version commit needed - version is derived at build time)
          git tag -a "v${VERSION}" -m "Release v${VERSION}"
          git push origin "v${VERSION}"

      - name: Create GitHub Release
        if: steps.version.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}+${{ steps.version.outputs.build_number }}"
          LAST_TAG="${{ steps.version.outputs.last_tag }}"

          if [ -n "$LAST_TAG" ]; then
            gh release create "v${VERSION}" \
              --title "v${VERSION}" \
              --generate-notes \
              --notes-start-tag "$LAST_TAG"
          else
            gh release create "v${VERSION}" \
              --title "v${VERSION}" \
              --generate-notes
          fi
