default_platform(:ios)

platform :ios do
  desc "Build and upload to App Store Connect"
  lane :release do |options|
    # Setup App Store Connect API key from environment
    app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_content: ENV["ASC_KEY_CONTENT"],
      is_key_content_base64: true
    )

    # Create a temporary keychain for CI
    keychain_name = "fastlane_tmp_keychain"
    keychain_password = SecureRandom.base64(24)

    if is_ci?
      create_keychain(
        name: keychain_name,
        password: keychain_password,
        default_keychain: true,
        unlock: true,
        timeout: 3600,
        lock_when_sleeps: false
      )
    end

    # Sync code signing certificates and profiles via match
    match(
      type: "appstore",
      readonly: true,
      git_url: ENV["MATCH_GIT_URL"],
      git_branch: "main",
      keychain_name: is_ci? ? keychain_name : nil,
      keychain_password: is_ci? ? keychain_password : nil
    )

    # Get version info from options (passed from CI) or increment
    if options[:version]
      increment_version_number(
        version_number: options[:version],
        xcodeproj: "Runner.xcodeproj"
      )
    end

    if options[:build_number]
      increment_build_number(
        build_number: options[:build_number],
        xcodeproj: "Runner.xcodeproj"
      )
    else
      increment_build_number(xcodeproj: "Runner.xcodeproj")
    end

    # Build Flutter app first (from parent directory)
    Dir.chdir("..") do
      sh("flutter", "build", "ios", "--release", "--no-codesign",
         "--dart-define=API_URL=#{ENV['API_URL_PROD']}",
         "--dart-define=WEB_PUSH_CERTIFICATE_KEY_PAIR=#{ENV['WEB_PUSH_CERTIFICATE_PAIR']}")
    end

    # Build and sign the IPA
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      output_directory: "../build/ios/ipa",
      output_name: "SweepDreams.ipa",
      xcargs: "-allowProvisioningUpdates"
    )

    # Upload to App Store Connect (TestFlight)
    upload_to_testflight(
      skip_waiting_for_build_processing: true
    )

    # Cleanup keychain
    delete_keychain(name: keychain_name) if is_ci?
  end

  desc "Build only (no upload)"
  lane :build do |options|
    # Create a temporary keychain for CI
    keychain_name = "fastlane_tmp_keychain"
    keychain_password = SecureRandom.base64(24)

    if is_ci?
      create_keychain(
        name: keychain_name,
        password: keychain_password,
        default_keychain: true,
        unlock: true,
        timeout: 3600,
        lock_when_sleeps: false
      )
    end

    match(
      type: "appstore",
      readonly: true,
      git_url: ENV["MATCH_GIT_URL"],
      git_branch: "main",
      keychain_name: is_ci? ? keychain_name : nil,
      keychain_password: is_ci? ? keychain_password : nil
    )

    if options[:version]
      increment_version_number(
        version_number: options[:version],
        xcodeproj: "Runner.xcodeproj"
      )
    end

    if options[:build_number]
      increment_build_number(
        build_number: options[:build_number],
        xcodeproj: "Runner.xcodeproj"
      )
    end

    Dir.chdir("..") do
      sh("flutter", "build", "ios", "--release", "--no-codesign",
         "--dart-define=API_URL=#{ENV['API_URL_PROD'] || 'https://api.example.com'}",
         "--dart-define=WEB_PUSH_CERTIFICATE_KEY_PAIR=#{ENV['WEB_PUSH_CERTIFICATE_PAIR'] || ''}")
    end

    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      output_directory: "../build/ios/ipa",
      output_name: "SweepDreams.ipa",
      xcargs: "-allowProvisioningUpdates"
    )

    # Cleanup keychain
    delete_keychain(name: keychain_name) if is_ci?
  end
end
